name: Convert rules to DOMAIN fake_ip_filter

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ''
  push:
    branches: [ main ]
    paths:
      - "rule/**.yaml"
      - "rule/**.list"
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ inputs.branch != '' && inputs.branch || github.ref_name }}
    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # 3ï¸âƒ£ æ‰§è¡Œè§„åˆ™è½¬æ¢è„šæœ¬
      - name: Convert all rules to DOMAIN fake_ip_filter
        run: |
          python <<'PYCODE'
          import os, re, glob

          def convert_line(line: str):
              """å°† Clash classical / list è§„åˆ™è¡Œè½¬æ¢ä¸º domain æ¨¡å¼ï¼ˆç¬¦åˆå®˜æ–¹ fake-ip-filter æ ¼å¼ï¼‰"""
              line = line.strip()
              if not line or line.startswith("#"):
                  return None

              # å¿½ç•¥éåŸŸåè§„åˆ™
              if any(x in line for x in [
                  "IP-CIDR", "SRC-IP-CIDR", "DST-PORT",
                  "SRC-PORT", "GEOIP", "PROCESS-NAME"
              ]):
                  return None

              # å»é™¤ YAML æˆ– list å‰ç¼€ç¬¦å·
              line = line.lstrip("-").strip()

              # å¤„ç† classical è§„åˆ™è¯­æ³•
              if "," in line:
                  parts = line.split(",", 1)
                  rule = parts[0].strip()
                  value = parts[1].strip()
                  if rule == "DOMAIN-SUFFIX":
                      return f"+.{value}"
                  elif rule == "DOMAIN":
                      return value
                  elif rule == "DOMAIN-KEYWORD":
                      return f"*{value}*"
                  elif rule == "DOMAIN-WILDCARD":
                      return f"*.{value.lstrip('*.')}"
                  else:
                      return None

              # å¤„ç†çº¯åŸŸåæ¨¡å¼ (.list æ–‡ä»¶)
              # è‹¥æ˜¯ .example.com â†’ è§†ä¸º suffixï¼ŒåŠ  +
              if line.startswith("."):
                  return f"+{line}"
              # è‹¥æ˜¯ *.example.com â†’ ä¿ç•™
              if line.startswith("*."):
                  return line
              # è‹¥åŒ¹é…ä¸€èˆ¬åŸŸå
              if re.match(r"^[\w\-]+(\.[a-zA-Z]{2,})+$", line):
                  return line

              return None

          os.makedirs("rule_converted", exist_ok=True)
          files = glob.glob("rule/**/*.yaml", recursive=True) + glob.glob("rule/**/*.list", recursive=True)
          total = 0

          for path in files:
              with open(path, "r", encoding="utf-8") as f:
                  lines = f.readlines()
              converted = [convert_line(l) for l in lines]
              converted = [x for x in converted if x]
              if not converted:
                  print(f"âš ï¸ è·³è¿‡ï¼ˆæ— æœ‰æ•ˆåŸŸåï¼‰: {path}")
                  continue
              output = "payload:\n" + "\n".join([f" - '{x}'" for x in converted]) + "\n"
              new_path = os.path.splitext(path)[0] + "_fake_ip_filter.yaml"
              new_path = new_path.replace("rule/", "rule_converted/")
              os.makedirs(os.path.dirname(new_path), exist_ok=True)
              with open(new_path, "w", encoding="utf-8") as f:
                  f.write(output)
              total += 1
              print(f"âœ… å·²è½¬æ¢: {path} -> {new_path}")

          print(f"\nğŸ‰ å…±ç”Ÿæˆ {total} ä¸ª fake_ip_filter æ–‡ä»¶")
          PYCODE

      # 4ï¸âƒ£ æäº¤å¹¶æ¨é€ç»“æœï¼ˆå«è‡ªåŠ¨ rebase ä¿æŠ¤ï¼‰
      - name: Commit and push converted results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add rule_converted
          git commit -m "Auto convert to DOMAIN fake_ip_filter" || echo "No changes to commit."
          echo "ğŸ”„ Pulling latest changes from remote before push..."
          # é˜²æ­¢è¿œç¨‹å…ˆæ›´æ–°å¯¼è‡´ push è¢«æ‹’ç»
          git pull --rebase origin "${TARGET_BRANCH}" || true
          echo "ğŸš€ Pushing changes to ${TARGET_BRANCH}..."
          git push origin HEAD:"${TARGET_BRANCH}" || {
            echo "âŒ Push failed after rebase attempt, retrying with force-with-lease..."
            git push origin HEAD:"${TARGET_BRANCH}" --force-with-lease
          }
